const fs = require('fs')
const https = require('https')
const crypto = require('crypto')
const {getExpectedBinHash, getBinHash} = require('@applitools/eg-frpc')

const {FrpcDownloadError} = require('../src/utils')

module.exports = { downloadFrpc, getFrpcDownloadLink, getManualFrpcInstallingErrorMessage, getFrpcErrorMessage }

async function downloadFrpc({platform, arch, cacheDirectoryPath, frpcPath, shouldUpdate}) {
  const expectedHash = getExpectedBinHash({platform, arch})
  const url = getFrpcDownloadLink({platform, arch})

  try{
    await _downloadBin({ filename: frpcPath, url})
    const actualHash = await getBinHash(frpcPath)

    if (actualHash !== expectedHash) throw new Error(`Checksum failed: expected: ${expectedHash} actual: ${actualHash}`)
  }
  catch(e){
    console.log(e.message)
    fs.unlinkSync(frpcPath)
    
    throw new FrpcDownloadError(url, cacheDirectoryPath, frpcPath, getFrpcErrorMessage({url, cacheDirectoryPath, shouldUpdate}))
  }

  await fs.promises.chmod(frpcPath, 0o777)
}

function getFrpcDownloadLink({platform, arch}){
  return `https://exec-wus.applitools.com/frpc/0.45.0.1/${platform}/${arch}`
}

function getFrpcErrorMessage({url, cacheDirectoryPath, shouldUpdate }){
  const prefix = shouldUpdate? `We Failed to update applitools frpc`: `We Failed to install applitools frpc.`
  return `${prefix} Please download it from ${url} and locate it in ${cacheDirectoryPath}. Our SDK needs the file for running a tunnel`
}

function getManualFrpcInstallingErrorMessage({platform, arch, shouldUpdate, cacheDirectoryPath, frpcPath}){
  const prefix = shouldUpdate ? `Please update frpc file. We found that there is a file on ${frpcPath} but we need newer version`:
  `Please Download frpc file and locate is in ${cacheDirectoryPath}. Our SDK needs the file ${frpcPath}`

  return `${prefix}. You can download the file from ${getFrpcDownloadLink({platform,arch})}`
}

const _downloadBin = function ({filename, url}) {
  return new Promise((resolve, reject) => {
    const file = fs.createWriteStream(filename)

    https
      .get(url, function (response) {
        response.pipe(file)
        file.on('finish', function () {
          file.close((err) => {
            if (!err) resolve()
            else reject(err)
          })
        })
      })
      .on('error', function (err) {
        fs.unlinkSync(filename)
        reject(err)
      })
  })
}
