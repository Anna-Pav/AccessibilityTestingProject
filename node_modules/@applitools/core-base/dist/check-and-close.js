"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeCheckAndClose = void 0;
const transform_target_1 = require("./utils/transform-target");
function makeCheckAndClose({ requests, done, signal, logger: defaultLogger }) {
    return async function checkAndClose({ target, settings, logger = defaultLogger, }) {
        var _a, _b, _c, _d, _e;
        settings !== null && settings !== void 0 ? settings : (settings = {});
        (_a = settings.normalization) !== null && _a !== void 0 ? _a : (settings.normalization = {});
        settings.normalization.limit = {
            maxImageHeight: Math.min((_c = (_b = settings.normalization.limit) === null || _b === void 0 ? void 0 : _b.maxImageHeight) !== null && _c !== void 0 ? _c : Infinity, requests.test.account.maxImageHeight),
            maxImageArea: Math.min((_e = (_d = settings.normalization.limit) === null || _d === void 0 ? void 0 : _d.maxImageArea) !== null && _e !== void 0 ? _e : Infinity, requests.test.account.maxImageArea),
        };
        logger.log('Command "checkAndClose" is called with settings', settings);
        target = await (0, transform_target_1.transformTarget)({ target, settings });
        if (signal.aborted) {
            throw new Error('Command "checkAndClose" was aborted');
        }
        return requests.checkAndClose({ target, settings, logger }).finally(done);
    };
}
exports.makeCheckAndClose = makeCheckAndClose;
